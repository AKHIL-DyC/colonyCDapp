ARG BLOCK_INGESTOR_HASH=master

FROM colony-cdapp-dev-env/base:latest

# Declare volumes to set up metadata
VOLUME [ "/colonyCDapp/amplify/mock-data" ]

# Add dependencies from the host
# Note: these are listed individually so that if they change, they won't affect
# the build of the other images
ADD scripts/run-block-ingestor.sh.base /colonyCDappBackend/scripts/run-block-ingestor.sh.base

WORKDIR /colonyCDappBackend

#
# Block Ingestor
#

# Clone block ingestor repo
RUN git clone https://github.com/JoinColony/block-ingestor.git --depth 1
WORKDIR /colonyCDappBackend/block-ingestor

# Fetch the correct network repo commit/branch/tag
RUN git fetch origin $BLOCK_INGESTOR_HASH --depth 1
RUN git checkout $BLOCK_INGESTOR_HASH

# Install block ingestor dependencies
RUN npm install

WORKDIR /colonyCDappBackend

# Hidrate the run script
RUN cp /colonyCDappBackend/scripts/run-block-ingestor.sh.base /colonyCDappBackend/run.sh
RUN chmod +x ./run.sh

# Battlecruiser Operational!
CMD [ "./run.sh" ]
